<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Configuration | Merest</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
<h1 class="page-title">API Configuration</h1>
<section>
    <article>
      <a name='levels'></a>
      <h3>Configuration levels</h3>
      <p><strong>merest</strong> allows to configure your API on three levels:
        <ol>
          <li>API Application</li>
          <li>Model router</li>
          <li>End-point</li>
        </ol>
        The schema is on the pic. bellow:
      </p>
      <img src="images/merest-conf-levels.gif">

      <a name='app'></a>
      <h3>Setting up an API Application</h3>
      <p>In order to configure API Application you should to pass the <code>options</options>
        parameter to the <code>merest.ModelAPIExpress</code> contructor:
      </p>
<pre class="prettyprint source lang-javascript"><code>const api = new merest.ModelAPIExpress({
  title: 'Merest-Sample API',
  path: '/api/v1',
  host: 'localhost:8000',
  options: false,
  transformResponse: &lt;function&gt;
});</code></pre>
  <p>Avaliable parameters are:</p>
  <ul>
    <li><strong>title</strong>: <code>String</code> - The title of api. &lt;<code>SWAGGER</code>&gt;</li>
    <li><strong>path</strong>: <code>String</code> - The path of api root. The application doesn't mount it self on this path. &lt;<code>SWAGGER</code>&gt;</li>
    <li><strong>host</strong>: <code>String</code> - The host to reach API. &lt;<code>SWAGGER</code>&gt;</li>
    <li><strong>options</strong>: <code>Boolean</code> - allows or denies the OPTION end-point on the application level</li>
    <li><strong>transformResponse</strong>: <code>Function</code> - the function to transform standard response. For details see <a href="end-points.html#transform-response">Transform response</a></li>
  </ul>
  <p>&lt;<code>SWAGGER</code>&gt; - the parameter is mandatory for correct <strong>swagger</strong> support</p>

  <a name='router'></a>
  <h3>Router configuration</h3>
      <p>
        To expose <code>mongoose.Model</code> you should create an API Router.
        It could be done in two ways:
        <ul>
          <li>By calling <code>ModelAPIExpress.expose</code> method</li>
          <li>By creating <code>ModelAPIRouter</code> and then exposing it with <code>ModelAPIExpress.expose</code></li>
        </ul>
      </p>

      <p>Using <code>ModelAPIExpress.expose</code>:</p>
<pre class="prettyprint source lang-javascript"><code>const api = new merest.ModelAPIExpress();

api.expose(models.Vector, {
  // router configuration parameters should be here
});</code></pre>

<p>Creating <code>ModelAPIRouter</code> explicitly:</p>
<pre class="prettyprint source lang-javascript">const api = new merest.ModelAPIExpress();
const vectorApi = new merest.ModelAPIRouter(models.Vector, {
  // router configuration parameters should be here
});

api.expose(vectorApi);</code></pre>

<p><strong>merest</strong> supports wide range of router configuration parameters:</p>
<pre class="prettyprint source lang-javascript"><code>var api = new merest.ModelAPIExpress();
api.expose(models.Vector, {
  path: '/cool-vectors', // overrides standard /model-plural-name path
  options: false, // disables end-point for OPTIONS method
  create: 'get', // mounts the CREATE end-point on the HTTP GET method
  search: 'post', // mounts the SEARCH end-point on the HTTP POST to resolve path-conflict with CREATE end-point
  details: 'Show details for a vector', // assigns the description for DETAILS end-point
  update: 'put', // mounts UPDATE end-point to the HTTP PUT
  delete: false, // disables to delete vectors
  fields: 'x y', // forces to response with x, y and _id fields
  matchId: '\d+' // configures the /:id routes with integer (not uuid) :id parameter
});</code></pre>


<h4>All router configuration parameters are:</h4><ul>
<li><strong>path</strong>: <code>String</code> -  the base path for all router end-points. It is relative to the api mounted path</li>
<li><strong>middlewares</strong>: <code>Function|Array(Function)</code> -  the middleware(s) that should be mounted on the base path of all end-points</li>
<li><strong>matchId</strong>: <code>String|RegExp</code> - the pattern to match values of <code>id</code> (<code>_id</code>) field in the end-point path. The default is <code>'[a-f\\d]{24}'</code></li>
<li><strong>options</strong>: <code>Boolean|String|Object</code> -  configuration for OPTIONS HTTP-method</li>
<li><strong>create</strong>: <code>Boolean|String|Object</code> - configuration for Instance creation</li>
<li><strong>search</strong>: <code>Boolean|String|Object</code> - configuration for searching of instances-</li>
<li><strong>details</strong>: <code>Boolean|String|Object</code> - configuration for instance details end-point</li>
<li><strong>update</strong>: <code>Boolean|String|Object</code> - configuration for instance update</li>
<li><strong>delete</strong>: <code>Boolean|String|Object</code> - configuration for instance removing</li>
<li><strong>expose</strong>: <code>Object</code> - configuration for instance method(s) exposition. (see. <a href="#methods">Model methods</a> for details)</li>
<li><strong>exposeStatic</strong>: <code>Object</code> - configuration for static method(s) exposition (see. <a href="#methods">Model methods</a> for details)</li>
</ul>
<p>Additionally some of end-point parameters could be specified on the router configuration level:
  <code>fields</code>, <code>populate</code>, <code>filter</code>, <code>readonly</code>
</p>
<p>Also some of end-points parameters are applicable exactly for one end-point <code>SEARCH</code>.
So it is reasonable to define them in the router level. These parameters are:
<code>queryFields</code>, <code>sort</code>, <code>limit</code>, <code>skip</code>,
</p>

<p>Parameters named as end-points (create, search, etc.) could be one of: <code>Boolean</code>, <code>String</code> and <code>Object</code>.</p>
<h5>In case of <code>Boolean</code>:</h5><ul>
<li><code>false</code>: appropriate end-point is disabled</li>
<li><code>true</code>: the end-point is allowed and default or common (see further) options will be used to configure it</li>
</ul>
<h5>In case of <code>String</code>:</h5><p>If value is some of HTTP-method supported by Express (<code>checkout</code>, <code>copy</code>, <code>delete</code>, <code>get</code>, <code>head</code>, <code>lock</code>, <code>merge</code>, <code>mkactivity</code>, <code>mkcol</code>, <code>move</code>, <code>'m-search'</code>, <code>notify</code>, <code>options</code>, <code>patch</code>, <code>post</code>, <code>purge</code>, <code>put</code>, <code>report</code>, <code>search</code>, <code>subscribe</code>, <code>trace</code>, <code>unlock</code>, <code>unsubscribe</code>), then the appropriate method is allowed and will be
mounted on specified HTTP-method.
Otherwise the value will be used as a description of the appropriate end-point returned
by the OPTIONS HTTP-method and swagger api-documentation</p>
<h5>In case of <code>Object</code>:</h5>
<p>The appropriate end-point is allowed and keys of the value will be used to configure this end-point.</p>
<p>The end-point configuration options are bellow.</p>

<a name='end-point'></a>
<h3>End-point configuration options:</h3>
<p>To configure end-point you should to specify appropriate router-level paramter with end-point
  configuration object. For instance, like that:</p>
<pre class="prettyprint source lang-javascript"><code>var api = new merest.ModelAPIExpress();
api.expose(models.Book, {
  details: { populate: 'author' }
});</code></pre>

<h4>All end-point configuration parameters are the following:</h4>
<ul>
<li><strong>path</strong>: <code>String</code> - <code>additional-path</code> of end-point</li>
<li><strong>method</strong>: <code>String</code> -- HTTP-method to mount appropriate end-point</li>
<li><strong>filter</strong>: <code>Object|Function</code> - Mongoose query-object or function that returns such object. The function receives <code>request</code> (Express Incoming Message) as only parameter. The function is executing in synchronous mode.</li>
<li><strong>fields</strong>: <code>Object|Array|String</code> - Mongoose field-selection parameter</li>
<li><strong>readonly</strong>: <strong>reserved</strong>,</li>
<li><strong>queryFields</strong>: <code>Object</code> - keys of the objects are names of fields. If value of the key is equal to false, the correspondent field will be excluded from the query. Affects on <code>search</code> end-point only.</li>
<li><strong>populate</strong>: <code>Array|Object|String</code> - Mongoose field population parameter</li>
<li><strong>skip</strong>: <code>Boolean</code> - allows or disables skipping documents in the search result. Affects on <code>search</code> end-point only.</li>
<li><strong>limit</strong>: <code>Boolean</code> - allows on denies limitation of documents in the search result. Affects on <code>search</code> end-point only.</li>
<li><strong>sort</strong>: <code>Boolean|Object</code> -- allows or denies (in case of <code>false</code>) the sorting. Object keys are names of the fields. The value of appropriate key allows or denies to sort by this field. Affects on <code>search</code> end-point only. The mongodb field paths could be used as keys of <code>sort</code>-object.</li>
<li><strong>middlewares</strong>: <code>Function|Array</code> - middleware function or array of such functions. The middleware(s) will be mounted to the end-point route as usual express middleware</li>
<li><strong>title</strong>: <code>String</code> - the description of the end-point</li>
</ul>
<p>Allmost all of described above options (excl. <code>method</code>, <code>path</code>, <code>title</code>) could be assigned also
on the router-level. In this case it will be applied to all applicable end-points if end-point doesn't override appropriate parameter directly.</p>
<pre class="prettyprint source lang-javascript"><code>var api = new merest.ModelAPIExpress();
api.expose(models.Vector, { // Model-routes level
  options: false, // end-point level
  update: 'put', // end-point level - update controller will be mounted on the PUT HTTP-method
  search: { // end-point level - search controller will be mounted
    method: 'post',  // on the POST HTTP-method
    path: '/search'  // on /search
  }
  fields: { // Model-routes level
    x: true,
    y: true,
    _id: false
  }
});</code></pre><p>Calling API:</p>
<pre class="prettyprint source lang-shell"><code>curl -X OPTIONS http://localhost:1337/api/v1/</code></pre><p>Output:</p>
<pre class="prettyprint source lang-shell"><code>[
  ["options", "/api/v1/", "List all end-points of current application"],
  ["post", "/api/v1/vectors/search", "List/Search all vectors"],
  ["post", "/api/v1/vectors/", "Create a new Vector"],
  ["get", "/api/v1/vectors/:id", "Find a Vector by Id"],
  ["put", "/api/v1/vectors/:id", "Find a Vector by Id and update it (particulary)"],
  ["delete", "/api/v1/vectors/:id", "Find a Vector by Id and delete it."]
]</code></pre><p>If paraneter <strong>path</strong> is assigned on the router-level it will be used as end-point sub-path
instead of Model collection name (plural).</p>

<a name="methods"></a>
<h3>Model methods</h3>
<p>As pointed <a href="#router">above</a> the router level has two parameters that allow to call model methods through the api.
These parameters are:</p>
<ul>
<li>expose: <code>Object</code> - configuration for end-points that expose the instance methods defined on its schema</li>
<li>exposeStatic: <code>Object</code> - configuration for end-points that expose static model methods defined on its schema.</li>
</ul>
<p>The keys of these paramters are the names of the Model methods (instance or static).
The each value of the key could be on of types: <code>Boolean</code>|<code>String</code>|<code>Object</code></p>
<pre class="prettyprint source lang-javascript"><code>{
  expose: {
    methodName: `Boolean` | `String` | `Object`,
    methodName: `Boolean` | `String` | `Object`
    ...
  },
  exposeStatic: {
    methodName: `String` | `Object`,
    ...
  }
}</code></pre>

<h4>In case of <code>Boolean</code></h4>
<p>the value means if method-end-point is allowed (<code>true</code>) or is disabled (<code>false</code>).
<p>There is a special key <code>"*"</code> that allows to enable or to disable all methods together.</p>
<pre class="prettyprint source lang-javascript"><code>{
  expose: {'*': true} // all instance method will be exposed
}</code></pre>

<h4>In case of <code>String</code></h4>
<p><strong>merest</strong> mounts controller that calls correspondent method
to the HTTP-method specified by value (if value is on of Express-supported HTTP-methods).</p>
<p>Otherwise (the value is not a HTTP-method) <strong>merest</strong> mounts appropriate controller
to POST (or other method specified directly) and adds created method-end-point
to list with value as description.</p>

<h4>In case of <code>Object</code></h4>
<p><strong>merest</strong> uses the value to configure method-end-point with the following parameters:</p>
<ul>
<li><strong>method</strong>:<code>String</code> - the HTTP method to mount method-end-point (if omitted the method-controller will be mount on the POST)</li>
<li><strong>path</strong>: <code>String</code> - the <code>additional-path</code> to mount method-controller</li>
<li><strong>exec</strong>:<code>Function</code> - the Function that will be called instead of Model instance/static
method with context of Document or the Model. You could to call any Model method from this
function using <code>this</code>.</li>
<li><strong>middlewares</strong>: <code>Function|Array</code> - middleware function or array of such functions. The middleware(s) will be mounted to the method-end-point route as usual express middleware</li>
<li><strong>title</strong>: <code>String</code> - the description of the end-point</li>
</ul>

<h4>Signature of Model method that can be exposed</h4>
<p>The controller that calls certain Model method passes to the one two parameters:</p>
<ul>
<li><strong>params</strong>: <code>Object</code> - parameters sent from client (in the Query String or in Request
Body dependent on the HTTP method used to mount method-end-point)</li>
<li><strong>callback</strong>: <code>Function</code> - Function that should be called after method processed.</li>
</ul>
<p><strong>Signature of callback-function</strong>:</p>
<pre class="prettyprint source lang-javascript"><code>
/**
 * @param  {Error} err                        exception raised in the method call
 * @param  {Object|Array|String} dataToReturn The data to be return in Response Body
 */
function callback(err, dataToReturn) {
  ...
}</code></pre>
<p>For example:</p>
<pre class="prettyprint source lang-javascript"><code>VectorSchema.methods.reverse = function(options, callback) {
  this.x = -this.x;
  this.y = -this.y;
  return this.save(callback);
}</code></pre><p>or in case of <code>statics</code>:</p>
<pre class="prettyprint source lang-javascript"><code>VectorSchema.statics.reverse = function(options, callback) {
  var self = this;
  self.update({}, {$mul: {x:-1, y:-1} }, {multi: true}, function (err) {
    if (err) return done(err);
    return self.find(callback);
  });
}</code></pre><p>Exposing the method</p>
<pre class="prettyprint source lang-javascript"><code>var api = new merest.ModelAPIExpress();
api.expose(models.Vector, { // Model-routes level
  fields: 'x y',
  expose: {
    reverse: 'get'
  }
});</code></pre>

<p>Getting the vector details:</p>
<pre class="prettyprint source lang-shell"><code>curl -g http://localhost:1337/api/v1/vectors/573f19d35b54089f3993605f/</code></pre>
<p>Output:</p>
<pre class="prettyprint source lang-shell"><code>{"_id": "573f19d35b54089f3993605f", "x": 1, "y": 2}</code></pre>
<p>Calling method-end-point:</p>
<pre class="prettyprint source lang-shell"><code>curl -g http://localhost:1337/api/v1/vectors/573f19d35b54089f3993605f/reverse</code></pre>
<p>Output:</p>
<pre class="prettyprint source lang-shell"><code>{"__v": 1, "_id": "573f19d35b54089f3993605f", "x": -1, "y": -2}</code></pre>
<p>Getting the vector details again:</p>
<pre class="prettyprint source lang-shell"><code>curl -g http://localhost:1337/api/v1/vectors/573f19d35b54089f3993605f/</code></pre>
<p>Output:</p>
<pre class="prettyprint source lang-shell"><code>{"_id": "573f19d35b54089f3993605f", "x": -1, "y": -2}</code></pre>
<p>Lookout the <strong>merest</strong> doesn't clean the response from exposed methods.
So, you should do it by your own code.</p>

<br class="clear">
<hr>
<a href='installation.html'>Next (Installation) ></a>
</article>
</section>
</div>

<nav><h2>
  <a href="index.html">merest</a>
</h2>

<h3><a href="installation.html">Installation</a></h3>
<ul>
  <li><a href="installation.html#prerequisites">Prerequisites</a></li>
  <li><a href="installation.html#npm-install">npm installation</a></li>
  <li><a href="installation.html#development">Development</a></li>
</ul>

<h3><a href="cook-book.html">Cook-book</a></h3>

<h3><a href="configuration.html">API Configuration</a></h3>
<ul>
  <li><a href="configuration.html#levels">Configuration levels</a></li>
  <li><a href="configuration.html#app">API Application</a></li>
  <li><a href="configuration.html#router">Router</a></li>
  <li><a href="configuration.html#end-point">End-point</a></li>
  <li><a href="configuration.html#methods">Model methods</a></li>
</ul>

<h3><a href="end-points.html">API Requests and Responses</a></h3>
<ul>
  <li><a href="end-points.html">Common reponses</a></li>
  <li><a href="end-points.html#ep_options">Options</a></li>
  <li><a href="end-points.html#ep_search">Search</a></li>
  <li><a href="end-points.html#ep_create">Create</a></li>
  <li><a href="end-points.html#ep_details">Details</a></li>
  <li><a href="end-points.html#ep_update">Update</a></li>
  <li><a href="end-points.html#ep_delete">Delete</a></li>
  <li><a href="end-points.html#transform-response">Custom response</a></li>
</ul>

<h3><a href="swagger.html">Swagger support</a></h3>
<ul>
  <li><a href="swagger.html#install">Installation</a></li>
  <li><a href="swagger.html#api-conf">Configure API</a></li>
  <li><a href="swagger.html#document">Creating <code>swagger.json</code></a></li>
  <li><a href="swagger.html#api-docs">Exposing the api-docs</a></li>
  <li><a href="swagger.html#swagger-ui">Embedded swagger-ui</a></li>
</ul>

<h3>Specifications</h3>
<ul>
  <li><a href="ModelAPIError.html">ModelAPIError</a></li>
  <li><a href="ModelAPIExpress.html">ModelAPIExpress</a></li>
  <li><a href="ModelAPIRouter.html">ModelAPIRouter</a></li>
</ul>
</nav>

<br class="clear">

<footer>
    Documentation generated with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
